---
title: 保存登录状态
cover: false
abbrlink: f77c5690
date: 2020-10-17 18:50:09
updated:
categories:
  - 前端
  - 浏览器
tags:
  - cookie
  - session
  - token
---
*HTTP 是一种无状态的协议，客户端每次发送请求时，首先要和服务器端建立一个连接，在请求完成后又会断开这个连接。*

*这种方式可以节省传输时占用的连接资源，但同时也存在一个问题：每次请求都是独立的，服务器端无法判断本次请求和上一次请求是否来自同一个用户，进而也就无法判断用户的登录状态。*

登录的过程很简单：输入账号密码，调用登录接口，数据库验证，登录成功。

关键是如何保存登录状态 —— 就是在一段时间之内让服务器记住我之前已经登陆过一次并且成功的状态，在下一次访问相同的网站，可以省去数据库验证账号密码的过程。

基本思想就是：**服务器保留某个用户的登录状态，下次访问网站发送用户的标识符匹配，直接返回登录状态。**

## Cookie + Session
cookie：存储在客户端的一小段数据，它可以存在硬盘中（永久cookie），也可以存在内存中（临时cookie）
session：服务器为某个会话开启的一段独特的存储空间，一个session用唯一的sessionid对应一段存储空间

这两个都可以用来存储用户信息，cookie是客户端的，session是服务器上的。

- 用户初次登录的状态可以用session保存，sessionid唯一标识该状态；
- cookie在浏览器上存储sessionid，访问网站时cookie通过http传给服务器；
- 服务器取出cookie中的sessionid匹配登录状态，匹配成功就登录成功了。

虽然我们使用 cookie+session 的方式完成了登录验证，但仍然存在一些问题：
- 由于服务器端需要对接大量的客户端，也就需要存放大量的SessionId，这样会导致服务器压力过大；
- 如果服务器端是一个集群，为了同步登录态，需要将 SessionId 同步到每一台机器上，无形中增加了服务器端维护成本；
- 由于 SessionId 存放在 Cookie 中，所以无法避免 CSRF 攻击。

## Token 登录
Token 是服务端生成的一串字符串，以作为客户端请求的一个令牌。

当第一次登录后，服务器会生成一个 Token 并返回给客户端，客户端后续访问时，只需带上这个 Token 即可完成身份认证。

相比cookie+session，token有以下优点：
- 服务器端不需要存放 Token，所以不会对服务器端造成压力，即使是服务器集群，也不需要增加维护成本。
- Token 可以存放在前端任何地方，可以不用保存在 Cookie 中，提升了页面的安全性。
- Token 下发之后，只要在生效时间之内，就一直有效，如果服务器端想收回此 Token 的权限，并不容易。

token的方式并不像cookie+session那样，服务器需要去知道“谁登录了”，相反，token只在乎自己有没有效（无篡改不过期），就允许传回该token的用户登录成功。

## SSO 单点登录 + Cookie
单点登录指的是在公司内部搭建一个公共的认证中心，公司下的所有产品的登录都可以在认证中心里完成，一个产品在认证中心登录后，再去访问另一个产品，可以不用再次登录，即可获取登录状态。

SSO 机制实现的关键就是公共的认证中心，它统一管理着一个共享的登录态，该登录状态可以通过Cookie来存储。

## OAuth 第三方登录 + Cookie
适用于一些小企业，在网络上很常见，通常是大厂提供的，比如通过qq、微博、微信以及github第三方登录。

基本过程
- 企业申请第三方应用appid、appsecret，并配置
- 用户登录企业网站，授权第三方应用得到一个code
- 加上企业配置的appid、appsecret，一起向第三方企业申请一个token，用于获取用户头像昵称等信息
- 最后将登录状态写入Cookie

## 总结
- Cookie + Session 历史悠久，适合于简单的后端架构，需开发人员自己处理好安全问题。
- Token 方案对后端压力小，适合大型分布式的后端架构，但已分发出去的 token ，如果想收回权限，就不是很方便了。
- SSO 单点登录，适用于中大型企业，想要统一内部所有产品的登录方式。
- OAuth 第三方登录，简单易用，对用户和开发者都友好，但第三方平台很多，需要选择合适自己的第三方登录平台。


参考：
  - [前端登录，这一篇就够了](https://juejin.im/post/6845166891393089544)
