---
title: 作用域和执行上下文
cover: false
categories:
  - 前端
  - JS
  - JS进阶
tags:
  - 作用域
  - 作用域链
  - 执行上下文
  - 执行上下文栈
abbrlink: e7d8983e
date: 2020-09-25 22:33:16
updated:
---
## 作用域
作用域是在运行时代码中的某些特定部分中变量，函数和对象的可访问性。换句话说，作用域决定了代码区块中变量和其他资源的可见性。
### 类型
作用域总共有三种类型：
- 全局作用域：最外层函数、最外层函数外面定义的变量、所有末定义直接赋值的变量自动声明为拥有全局变量、所有 window 对象的属性
- 函数作用域：函数中定义的变量
- 块级作用域：ES6通过新增命令 let 和 const 来体现`{}`包裹的为一个块级作用域，块级作用域不会创建一个新的作用域，所以在块语句中定义的变量将保留在它们已经存在的作用域中。

作用域就是一个独立的地盘，让变量不会外泄、暴露出去。也就是说作用域最大的用处就是隔离变量，不同作用域下同名变量不会有冲突。
#### 作用域链
由当前环境与上层环境的一系列变量对象组成，它保证了当前执行环境对符合访问权限的变量和函数的有序访问，即内层作用域可以访问外层作用域的变量，反之则不行。

##### 自由变量
当前作用域没有定义的变量，将成为自由变量，自由变量需要到创建这个函数的那个域（某个父级域）中寻找。

## 执行上下文
简而言之，执行上下文就是当前 JS 代码被解析和执行时所在环境的抽象概念，JS 中运行任何的代码都是在执行上下文中运行。
### 类型
执行上下文总共有三种类型：

- 全局执行上下文： 这是默认的、最基础的执行上下文，不在任何函数中的代码都位于全局执行上下文中。它做了两件事：
	- 创建一个全局对象，在浏览器中这个全局对象就是 window 对象。
	- 将 this 指针指向这个全局对象。一个程序中只能存在一个全局执行上下文。
- 函数执行上下文： 每次调用函数时，都会为该函数创建一个新的执行上下文。
	- 每个函数都拥有自己的执行上下文，但是只有在函数被调用的时候才会被创建。
	- 一个程序中可以存在任意数量的函数执行上下文，每当一个新的执行上下文被创建，会被放入执行上下文栈
- Eval 函数执行上下文： 运行在 eval 函数中的代码也获得了自己的执行上下文，eval 函数不常用，所以在这里不再讨论

### 生命周期
执行上下文的生命周期包括三个阶段：创建阶段 → 执行阶段 → 回收阶段：
1. 创建阶段
	当函数被调用，但未执行任何其内部代码之前，会做以下三件事：

	- 创建变量对象：首先初始化函数的参数 arguments，提升函数声明和变量声明。
	- 创建作用域链（Scope Chain）：在执行期上下文的创建阶段，作用域链是在变量对象之后创建的，作用域链本身包含变量对象，用于解析变量。
	- 确定 this 指向
2. 执行阶段
	执行变量赋值、代码执行
3. 回收阶段
	执行上下文出栈等待虚拟机回收执行上下文

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);display:inline;margin:0" 
    src="https://cdn.jsdelivr.net/gh/DSzhongweizi/Resources/article/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" width=600 />
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;">执行上下文生命周期</div>
</center>

### 执行上下文栈
执行上下文栈认为是一个存储函数调用的栈结构，遵循先进后出的原则。

关键点：
- JavaScript 执行在单线程上，所有的代码都是排队执行。
- 一开始浏览器执行全局的代码时，首先创建全局的执行上下文，压入执行栈的顶部。
- 每当进入一个函数的执行就会创建函数的执行上下文，并且把它压入执行栈的顶部。当前函数执行完成后，当前函数的执行上下文出栈，并等待垃圾回收。
- 浏览器的 JS 执行引擎总是访问栈顶的执行上下文。
- 全局上下文只有唯一的一个，它在浏览器关闭时出栈。
